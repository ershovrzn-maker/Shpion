```html
<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Шпион</title>

<style>
  body {
    margin: 0;
    font-family: system-ui, Arial, sans-serif;
    background: #0b0f1a;
    color: #e9eefc;
  }
  .wrap {
    max-width: 720px;
    margin: 0 auto;
    padding: 20px;
  }
  h1 {
    font-size: 22px;
    margin-bottom: 14px;
  }
  .panel {
    background: #121a2b;
    border-radius: 14px;
    padding: 16px;
  }
  .row {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
    flex-wrap: wrap;
    align-items: center;
  }
  input, select {
    flex: 1;
    padding: 10px;
    border-radius: 10px;
    border: none;
    font-size: 14px;
    outline: none;
  }
  button {
    padding: 10px 14px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    font-weight: 600;
  }
  button:disabled { opacity: .55; cursor: not-allowed; }

  .add { background: #2a3b67; color: #fff; }
  .play { background: #7aa2ff; color: #081022; }
  .reset { background: #1f2c4c; color: #fff; }
  .danger { background: #4c1f2a; color: #fff; }

  .list { margin-top: 2px; }
  .pill {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: rgba(255,255,255,.08);
    padding: 6px 10px;
    border-radius: 8px;
    margin: 4px 6px 0 0;
    font-size: 13px;
  }
  .pill .x {
    width: 20px;
    height: 20px;
    border-radius: 6px;
    background: rgba(255,255,255,.12);
    color: #e9eefc;
    border: none;
    cursor: pointer;
    font-weight: 800;
    line-height: 1;
    padding: 0;
  }

  .grid {
    display: grid;
    gap: 10px;
    margin-top: 12px;
  }
  @media (min-width: 600px) {
    .grid { grid-template-columns: 1fr 1fr; }
  }

  .card {
    background: rgba(255,255,255,.04);
    border-radius: 12px;
    padding: 12px;
  }
  .namebtn {
    width: 100%;
    padding: 12px;
    border-radius: 10px;
    background: rgba(255,255,255,.06);
    color: #fff;
    border: none;
    font-weight: 700;
  }
  .role {
    margin-top: 10px;
    padding: 10px;
    background: rgba(0,0,0,.25);
    border-radius: 10px;
    font-weight: 700;
  }
  .role.spy {
    background: rgba(122,162,255,.18);
    border: 1px solid rgba(122,162,255,.35);
  }
  .hint {
    font-size: 13px;
    color: #9fb0d0;
    margin-bottom: 10px;
    line-height: 1.35;
  }
  .status {
    font-size: 13px;
    color: #9fb0d0;
    margin-top: 8px;
  }

  .opt {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    color: #9fb0d0;
    font-size: 13px;
    user-select: none;
  }
  .opt input { flex: 0; width: 18px; height: 18px; }
</style>
</head>

<body>
<div class="wrap">
  <h1>Игра «Шпион»</h1>

  <div class="panel">

    <div class="row">
      <select id="universe">
        <option value="harry">Гарри Поттер</option>
        <option value="marvel">Marvel</option>
        <option value="sherlock">Шерлок Холмс</option>
        <option value="starwars">Звёздные войны</option>
      </select>

      <select id="spyCount" title="Количество шпионов"></select>

      <label class="opt" title="Если выключить, карточки будут в порядке списка игроков">
        <input id="shuffleCards" type="checkbox" checked>
        Перемешивать карточки
      </label>
    </div>

    <div class="row">
      <input id="nameInput" placeholder="Имя игрока" autocomplete="off">
      <button class="add" id="addBtn" type="button">Добавить</button>
      <button class="danger" id="delLastBtn" type="button" title="Удалить последнего игрока в списке">Удалить</button>
    </div>

    <div class="list" id="playerList"></div>

    <div class="row">
      <button class="play" id="playBtn" type="button">Играть</button>
      <button class="reset" id="newRoundBtn" type="button" title="Новая партия, список игроков сохраняется">Новая партия</button>
      <button class="reset" id="resetBtn" type="button">Сброс</button>
    </div>

    <div class="hint">
      Нажми «Играть» (или «Новая партия»). Нажми на имя, чтобы увидеть роль.
      Нажми ещё раз по этому игроку, чтобы карточка исчезла.
    </div>

    <div class="grid" id="grid"></div>
    <div class="status" id="status"></div>

  </div>
</div>

<script>
  // Вселенные внутри одного файла (без fetch)
  const UNIVERSES = {
    harry: [
      "Гарри Поттер", "Гермиона Грейнджер", "Рон Уизли", "Драко Малфой",
      "Альбус Дамблдор", "Северус Снегг", "Минерва Макгонагалл",
      "Рубеус Хагрид", "Волан-де-Морт", "Сириус Блэк", "Джинни Уизли",
      "Невилл Долгопупс", "Луна Лавгуд", "Беллатриса Лестрейндж",
      "Доби", "Фред Уизли", "Джордж Уизли"
    ],
    marvel: [
      "Тони Старк", "Стив Роджерс", "Тор", "Наташа Романофф",
      "Брюс Беннер", "Клинт Бартон", "Питер Паркер", "Локи",
      "Т'Чалла", "Доктор Стрэндж", "Ванда Максимофф", "Скотт Лэнг",
      "Питер Квилл", "Гамора", "Ракета", "Грут", "Ник Фьюри"
    ],
    sherlock: [
      "Шерлок Холмс", "Доктор Ватсон", "Миссис Хадсон", "Инспектор Лестрейд",
      "Профессор Мориарти", "Майкрофт Холмс", "Ирен Адлер", "Мэри Морстен",
      "Тоби (пёс)", "Скотленд-Ярд"
    ],
    starwars: [
      "Люк Скайуокер", "Лея Органа", "Хан Соло", "Чубакка",
      "Дарт Вейдер", "Оби-Ван Кеноби", "Йода", "Палпатин",
      "R2-D2", "C-3PO", "Боба Фетт", "Падме Амидала",
      "Кайло Рен", "Рей", "Финн"
    ]
  };

  // Сохранение списка игроков (пункт 4)
  const STORAGE_KEY = "spy_game_players_v1";

  let players = [];
  let roundActive = false;

  // Не повторять персонажа подряд в рамках одной вселенной
  const lastCharacterByUniverse = Object.create(null);

  const universeSel = document.getElementById("universe");
  const spyCountSel = document.getElementById("spyCount");
  const shuffleCardsChk = document.getElementById("shuffleCards");

  const nameInput = document.getElementById("nameInput");
  const playerList = document.getElementById("playerList");
  const grid = document.getElementById("grid");
  const status = document.getElementById("status");

  const addBtn = document.getElementById("addBtn");
  const delLastBtn = document.getElementById("delLastBtn");
  const playBtn = document.getElementById("playBtn");
  const newRoundBtn = document.getElementById("newRoundBtn");
  const resetBtn = document.getElementById("resetBtn");

  function setStatus(text) { status.textContent = text || ""; }

  function setControlsLocked(isLocked) {
    universeSel.disabled = isLocked;
    spyCountSel.disabled = isLocked ? true : (players.length < 3);
    shuffleCardsChk.disabled = isLocked;
  }

  function randInt(max) {
    return Math.floor(Math.random() * max);
  }

  // Fisher-Yates shuffle
  function shuffle(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = randInt(i + 1);
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  function normalizeName(s) {
    return s.trim().replace(/\s+/g, " ");
  }

  // Склонение "шпион"
  function spyLabel(k) {
    const mod10 = k % 10;
    const mod100 = k % 100;
    if (k === 0) return "0 шпионов";
    if (mod10 === 1 && mod100 !== 11) return `${k} шпион`;
    if (mod10 >= 2 && mod10 <= 4 && (mod100 < 12 || mod100 > 14)) return `${k} шпиона`;
    return `${k} шпионов`;
  }

  // Пункт 4: сохранение/загрузка списка игроков
  function savePlayers() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(players));
    } catch (e) {
      // Если localStorage недоступен, просто молча пропускаем
    }
  }
  function loadPlayers() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return [];
      const parsed = JSON.parse(raw);
      if (!Array.isArray(parsed)) return [];
      return parsed.filter(x => typeof x === "string").map(x => normalizeName(x)).filter(Boolean);
    } catch (e) {
      return [];
    }
  }

  // Важно для исправления ошибок: если меняем список игроков, активную партию сбрасываем
  function cancelRoundIfActive() {
    if (!roundActive) return;
    grid.innerHTML = "";
    roundActive = false;
    setControlsLocked(false);
    setStatus("Партия сброшена из-за изменения списка игроков. Нажмите «Играть».");
  }

  // Количество шпионов настраивается, опции зависят от количества игроков
  // Пункт 2: добавлен режим "0 шпионов"
  function recomputeSpyOptions() {
    const n = players.length;

    // При малом числе игроков фиксируем 0 и 1, блокируем
    if (n < 3) {
      spyCountSel.innerHTML = `
        <option value="0">0 шпионов</option>
        <option value="1">1 шпион</option>
      `;
      spyCountSel.value = "1";
      spyCountSel.disabled = true;
      return;
    }

    spyCountSel.disabled = false;

    // Максимум шпионов: не более n-1 и не более floor(n/2)
    const maxSpies = Math.min(n - 1, Math.floor(n / 2));
    const prev = parseInt(spyCountSel.value || "1", 10);

    spyCountSel.innerHTML = "";

    // 0 шпионов
    {
      const opt0 = document.createElement("option");
      opt0.value = "0";
      opt0.textContent = spyLabel(0);
      spyCountSel.appendChild(opt0);
    }

    for (let k = 1; k <= maxSpies; k++) {
      const opt = document.createElement("option");
      opt.value = String(k);
      opt.textContent = spyLabel(k);
      spyCountSel.appendChild(opt);
    }

    // Нормализуем выбранное значение
    const capped = Math.min(Math.max(prev, 0), maxSpies);
    spyCountSel.value = String(capped);
  }

  // Удаление любого игрока по кнопке X
  function removePlayerAt(index) {
    if (index < 0 || index >= players.length) return;
    cancelRoundIfActive();
    players.splice(index, 1);
    setStatus("");
    renderPlayers();
    savePlayers();
    nameInput.focus();
  }

  function renderPlayers() {
    playerList.innerHTML = "";

    players.forEach((n, idx) => {
      const pill = document.createElement("span");
      pill.className = "pill";

      const label = document.createElement("span");
      label.textContent = n;

      const x = document.createElement("button");
      x.className = "x";
      x.type = "button";
      x.title = "Удалить игрока";
      x.textContent = "×";
      x.onclick = () => removePlayerAt(idx);

      pill.appendChild(label);
      pill.appendChild(x);
      playerList.appendChild(pill);
    });

    delLastBtn.disabled = players.length === 0;
    playBtn.disabled = players.length < 3;
    newRoundBtn.disabled = players.length < 3;

    recomputeSpyOptions();

    // Если партия не активна, обновляем состояние контролов (в т.ч. spyCount)
    if (!roundActive) setControlsLocked(false);
  }

  function addPlayer() {
    const name = normalizeName(nameInput.value);
    if (!name) return;

    cancelRoundIfActive();

    // Запрет дублей (по регистронезависимому сравнению)
    const key = name.toLowerCase();
    if (players.some(p => p.toLowerCase() === key)) {
      setStatus("Игрок с таким именем уже добавлен.");
      nameInput.select();
      return;
    }

    players.push(name);
    nameInput.value = "";
    setStatus("");
    renderPlayers();
    savePlayers();
    nameInput.focus();
  }

  addBtn.onclick = addPlayer;

  nameInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") addPlayer();
  });

  delLastBtn.onclick = () => {
    if (players.length === 0) return;
    cancelRoundIfActive();
    players.pop();
    setStatus("");
    renderPlayers();
    savePlayers();
    nameInput.focus();
  };

  resetBtn.onclick = () => {
    players = [];
    grid.innerHTML = "";
    roundActive = false;
    setStatus("");
    setControlsLocked(false);
    renderPlayers();
    savePlayers();
    nameInput.focus();
  };

  // Уникальные индексы шпионов
  function pickUniqueIndices(count, maxExclusive) {
    const indices = [];
    const used = new Set();
    const safeCount = Math.max(0, Math.min(count, maxExclusive));
    while (indices.length < safeCount) {
      const v = randInt(maxExclusive);
      if (!used.has(v)) {
        used.add(v);
        indices.push(v);
      }
    }
    return indices;
  }

  // Не повторять персонажа подряд в выбранной вселенной (если есть выбор)
  function pickCharacterNoRepeat(universeKey, characters) {
    if (!characters.length) return null;
    const last = lastCharacterByUniverse[universeKey];

    if (characters.length === 1) {
      lastCharacterByUniverse[universeKey] = characters[0];
      return characters[0];
    }

    let chosen = characters[randInt(characters.length)];
    let guard = 0;
    while (chosen === last && guard < 20) {
      chosen = characters[randInt(characters.length)];
      guard++;
    }

    lastCharacterByUniverse[universeKey] = chosen;
    return chosen;
  }

  function startRound() {
    if (players.length < 3) {
      setStatus("Минимум 3 игрока.");
      return;
    }

    const universeKey = universeSel.value;
    const characters = UNIVERSES[universeKey] || [];
    if (!characters.length) {
      setStatus("Нет персонажей для выбранной вселенной.");
      return;
    }

    const spiesWanted = parseInt(spyCountSel.value || "1", 10);
    const spyIndices = new Set(pickUniqueIndices(spiesWanted, players.length));

    const commonCharacter = pickCharacterNoRepeat(universeKey, characters);
    if (!commonCharacter) {
      setStatus("Нет персонажей для выбранной вселенной.");
      return;
    }

    let assignments = players.map((name, i) => ({
      name,
      isSpy: spyIndices.has(i),
      role: spyIndices.has(i) ? "ТЫ ШПИОН" : commonCharacter
    }));

    // Если "Перемешивать карточки" включено, перемешиваем assignments
    if (shuffleCardsChk.checked) {
      assignments = shuffle(assignments);
    }

    grid.innerHTML = "";
    roundActive = true;
    setControlsLocked(true);
    setStatus("Роли распределены. Открывайте по очереди.");

    assignments.forEach(p => {
      const card = document.createElement("div");
      card.className = "card";

      const btn = document.createElement("button");
      btn.className = "namebtn";
      btn.type = "button";
      btn.textContent = p.name;

      let opened = false;
      btn.onclick = () => {
        if (!opened) {
          opened = true;

          const role = document.createElement("div");
          role.className = "role" + (p.isSpy ? " spy" : "");
          role.textContent = p.role;
          card.appendChild(role);
        } else {
          card.remove();
        }
      };

      card.appendChild(btn);
      grid.appendChild(card);
    });
  }

  playBtn.onclick = () => {
    if (roundActive) {
      grid.innerHTML = "";
    }
    startRound();
  };

  // Исправление ошибки: "Новая партия" не должна сразу раздавать роли,
  // иначе пользователь не успеет поменять параметры.
  newRoundBtn.onclick = () => {
    grid.innerHTML = "";
    roundActive = false;
    setControlsLocked(false);
    setStatus("Настройте параметры и нажмите «Играть».");
  };

  // Инициализация
  players = loadPlayers();
  renderPlayers();
  nameInput.focus();
</script>
</body>
</html>
```
