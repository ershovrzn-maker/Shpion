<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Игра «Шпион» v1.4</title>

<style>
  :root{
    --bg:#0b0f1a;
    --panel:#121a2b;
    --text:#e9eefc;
    --muted:#9fb0d0;

    --card:rgba(255,255,255,.04);
    --card2:rgba(255,255,255,.06);
    --chip:rgba(255,255,255,.08);
    --chip2:rgba(255,255,255,.12);

    --rolebg:rgba(0,0,0,.25);
    --spybg:rgba(122,162,255,.18);
    --spybord:rgba(122,162,255,.35);

    --r14:14px;
    --r12:12px;
    --r10:10px;
  }

  body{
    margin:0;
    font-family:system-ui, Arial, sans-serif;
    background:var(--bg);
    color:var(--text);
  }

  .wrap{
    max-width:760px;
    margin:0 auto;
    padding:20px;
  }

  h1{
    margin:0 0 14px 0;
    font-size:22px;
  }

  .panel{
    background:var(--panel);
    border-radius:var(--r14);
    padding:16px;
  }

  .row{
    display:flex;
    gap:10px;
    margin-bottom:10px;
    flex-wrap:wrap;
    align-items:center;
  }

  input, select{
    flex:1;
    padding:10px;
    border-radius:var(--r10);
    border:none;
    font-size:14px;
    outline:none;
  }

  button{
    padding:10px 14px;
    border-radius:var(--r10);
    border:none;
    cursor:pointer;
    font-weight:600;
  }

  button:disabled{
    opacity:.55;
    cursor:not-allowed;
  }

  .add{background:#2a3b67;color:#fff;}
  .play{background:#7aa2ff;color:#081022;}
  .reset{background:#1f2c4c;color:#fff;}
  .danger{background:#4c1f2a;color:#fff;}

  .opt{
    display:inline-flex;
    align-items:center;
    gap:8px;
    color:var(--muted);
    font-size:13px;
    user-select:none;
  }

  .opt input{
    flex:0;
    width:18px;
    height:18px;
  }

  .list{margin-top:2px;}

  .pill{
    display:inline-flex;
    align-items:center;
    gap:8px;
    background:var(--chip);
    padding:6px 10px;
    border-radius:8px;
    margin:4px 6px 0 0;
    font-size:13px;
  }

  .pill .x{
    width:20px;
    height:20px;
    border-radius:6px;
    background:var(--chip2);
    color:var(--text);
    border:none;
    cursor:pointer;
    font-weight:800;
    line-height:1;
    padding:0;
  }

  .hint{
    font-size:13px;
    color:var(--muted);
    margin:10px 0;
    line-height:1.35;
  }

  .status{
    font-size:13px;
    color:var(--muted);
    margin-top:8px;
  }

  .grid{
    display:grid;
    gap:10px;
    margin-top:12px;
  }

  @media (min-width:600px){
    .grid{grid-template-columns:1fr 1fr;}
  }

  .card{
    background:var(--card);
    border-radius:var(--r12);
    padding:12px;
  }

  .namebtn{
    width:100%;
    padding:12px;
    border-radius:var(--r10);
    background:var(--card2);
    color:#fff;
    border:none;
    font-weight:700;
  }

  .role{
    margin-top:10px;
    padding:12px;
    background:var(--rolebg);
    border-radius:var(--r10);
    font-weight:700;
  }

  .role.spy{
    background:var(--spybg);
    border:1px solid var(--spybord);
  }

  .role .char{
    display:flex;
    flex-direction:column;
    gap:10px;
    align-items:center;
    text-align:center;
  }

  .role img{
    width:min(90vw, 420px);
    height:min(90vw, 420px);
    object-fit:cover;
    border-radius:18px;
    border:1px solid rgba(255,255,255,.20);
    background:rgba(255,255,255,.04);
    flex:0 0 auto;
  }

  .role .charname{
    font-weight:800;
    font-size:16px;
  }

  .smallnote{
    font-size:12px;
    color:var(--muted);
    font-weight:600;
    line-height:1.25;
  }
</style>
</head>

<body>
<div class="wrap">
  <h1>Игра «Шпион» v1.4</h1>

  <div class="panel">
    <div class="row">
      <select id="universe" aria-label="Вселенная">
        <option value="harry">Гарри Поттер</option>
        <option value="marvel">Marvel</option>
        <option value="smeshariki">Смешарики</option>
      </select>

      <select id="spyCount" aria-label="Количество шпионов" title="Количество шпионов"></select>

      <label class="opt" title="Если выключить, карточки будут в порядке списка игроков">
        <input id="shuffleCards" type="checkbox" checked>
        Перемешивать карточки
      </label>
    </div>

    <div class="row">
      <input id="nameInput" placeholder="Имя игрока" autocomplete="off">
      <button class="add" id="addBtn" type="button">Добавить</button>
      <button class="danger" id="delLastBtn" type="button" title="Удалить последнего игрока в списке">Удалить</button>
    </div>

    <div class="list" id="playerList"></div>

    <div class="row">
      <button class="play" id="playBtn" type="button">Играть</button>
      <button class="reset" id="newRoundBtn" type="button" title="Новая партия, список игроков сохраняется">Новая партия</button>
      <button class="reset" id="resetBtn" type="button">Сброс</button>
    </div>

    <div class="hint">
      Нажмите «Играть». Нажмите на имя игрока, чтобы увидеть роль, персонажа и картинку.
      Повторный клик по этому же игроку удалит карточку с экрана.
      <div class="smallnote">
        Картинки должны лежать в репозитории по путям вида img/smeshariki/krosh.jpg и т.д.
      </div>
    </div>

    <div class="grid" id="grid"></div>
    <div class="status" id="status"></div>
  </div>
</div>

<script>
  "use strict";

  /*
    Персонажи: { name, img }
    Пример путей:
      img/harry/harry.jpg
      img/marvel/tony.jpg
      img/smeshariki/krosh.jpg
  */
  const UNIVERSES = {
    harry: [
      { name: "Гарри Поттер", img: "img/harry/harry.jpg" },
      { name: "Гермиона Грейнджер", img: "img/harry/hermione.jpg" },
      { name: "Рон Уизли", img: "img/harry/ron.jpg" },
      { name: "Драко Малфой", img: "img/harry/draco.jpg" },
      { name: "Альбус Дамблдор", img: "img/harry/dumbledore.jpg" },
      { name: "Северус Снегг", img: "img/harry/snape.jpg" },
      { name: "Минерва Макгонагалл", img: "img/harry/mcgonagall.jpg" },
      { name: "Рубеус Хагрид", img: "img/harry/hagrid.jpg" },
      { name: "Волан-де-Морт", img: "img/harry/voldemort.jpg" },
      { name: "Сириус Блэк", img: "img/harry/sirius.jpg" },
      { name: "Джинни Уизли", img: "img/harry/ginny.jpg" },
      { name: "Невилл Долгопупс", img: "img/harry/neville.jpg" },
      { name: "Луна Лавгуд", img: "img/harry/luna.jpg" },
      { name: "Беллатриса Лестрейндж", img: "img/harry/bellatrix.jpg" },
      { name: "Доби", img: "img/harry/dobby.jpg" },
      { name: "Фред Уизли", img: "img/harry/fred.jpg" },
      { name: "Джордж Уизли", img: "img/harry/george.jpg" }
    ],
    marvel: [
      { name: "Тони Старк", img: "img/marvel/tony.jpg" },
      { name: "Стив Роджерс", img: "img/marvel/steve.jpg" },
      { name: "Тор", img: "img/marvel/thor.jpg" },
      { name: "Наташа Романофф", img: "img/marvel/natasha.jpg" },
      { name: "Брюс Беннер", img: "img/marvel/bruce.jpg" },
      { name: "Клинт Бартон", img: "img/marvel/clint.jpg" },
      { name: "Питер Паркер", img: "img/marvel/peter.jpg" },
      { name: "Локи", img: "img/marvel/loki.jpg" },
      { name: "Т'Чалла", img: "img/marvel/tchalla.jpg" },
      { name: "Доктор Стрэндж", img: "img/marvel/strange.jpg" },
      { name: "Ванда Максимофф", img: "img/marvel/wanda.jpg" },
      { name: "Скотт Лэнг", img: "img/marvel/scott.jpg" },
      { name: "Питер Квилл", img: "img/marvel/quill.jpg" },
      { name: "Гамора", img: "img/marvel/gamora.jpg" },
      { name: "Ракета", img: "img/marvel/rocket.jpg" },
      { name: "Грут", img: "img/marvel/groot.jpg" },
      { name: "Ник Фьюри", img: "img/marvel/fury.jpg" }
    ],
    smeshariki: [
      { name: "Крош", img: "img/smeshariki/krosh.jpg" },
      { name: "Ёжик", img: "img/smeshariki/yozhik.jpg" },
      { name: "Нюша", img: "img/smeshariki/nyusha.jpg" },
      { name: "Бараш", img: "img/smeshariki/barash.jpg" },
      { name: "Копатыч", img: "img/smeshariki/kopatych.jpg" },
      { name: "Совунья", img: "img/smeshariki/sovunya.jpg" },
      { name: "Кар-Карыч", img: "img/smeshariki/karkarych.jpg" },
      { name: "Лосяш", img: "img/smeshariki/losyash.jpg" },
      { name: "Пин", img: "img/smeshariki/pin.jpg" },
      { name: "Биби", img: "img/smeshariki/bibi.jpg" },

      { name: "Панди", img: "img/smeshariki/pandi.jpg" },
      { name: "Лили", img: "img/smeshariki/lili.jpg" },
      { name: "Муля", img: "img/smeshariki/mulya.jpg" },
      { name: "Муня", img: "img/smeshariki/munya.jpg" },
      { name: "Мышарик", img: "img/smeshariki/mysharik.jpg" },
      { name: "Тигриция", img: "img/smeshariki/tigrizia.jpg" },
      { name: "Лягушка", img: "img/smeshariki/frog.jpg" },
      { name: "Железная няня", img: "img/smeshariki/iron_nanny.jpg" },
      { name: "Умникум", img: "img/smeshariki/umnikum.jpg" },
      { name: "Хрум", img: "img/smeshariki/hrum.jpg" },
      { name: "Шуша", img: "img/smeshariki/shusha.jpg" },
      { name: "Игогоша", img: "img/smeshariki/igogosha.jpg" },
      { name: "Чёрный Ловелас", img: "img/smeshariki/black_lovelace.jpg" },
      { name: "Жители Плутона", img: "img/smeshariki/pluto.jpg" },
      { name: "Гусеница Копатыча (Гусен Калигари)", img: "img/smeshariki/gusen.jpg" },
      { name: "Ушарик", img: "img/smeshariki/usharik.jpg" },
      { name: "Бу-Ханку", img: "img/smeshariki/bu_hanku.jpg" },
      { name: "Детище Лосяша из глины", img: "img/smeshariki/clay_child.jpg" },
      { name: "Клон Лосяша", img: "img/smeshariki/losyash_clone.jpg" },
      { name: "Дятел-нотариус", img: "img/smeshariki/woodpecker_notary.jpg" },
      { name: "Оживший бутерброд", img: "img/smeshariki/sandwich.jpg" },
      { name: "Тузя (кукла Нюши)", img: "img/smeshariki/tuzya.jpg" },
      { name: "Стражи полюсов", img: "img/smeshariki/poles.jpg" },
      { name: "Кот-певец", img: "img/smeshariki/singer_cat.jpg" },
      { name: "Микки Поль (серия «Массы и расстояния»)", img: "img/smeshariki/mickey_paul.jpg" },

      { name: "Червяки", img: "img/smeshariki/worms.jpg" },
      { name: "Резонанс", img: "img/smeshariki/resonance.jpg" },
      { name: "Отец Копатыча", img: "img/smeshariki/kopatych_father.jpg" },
      { name: "Прабабушка Совуньи", img: "img/smeshariki/sovunya_greatgrandmother.jpg" },
      { name: "Мистический герой", img: "img/smeshariki/mystic.jpg" },
      { name: "Коняш", img: "img/smeshariki/konyash.jpg" },
      { name: "Мармадюк", img: "img/smeshariki/marmaduk.jpg" },
      { name: "Шорк", img: "img/smeshariki/shork.jpg" },
      { name: "Крот", img: "img/smeshariki/mole.jpg" },
      { name: "Агент", img: "img/smeshariki/agent.jpg" },
      { name: "Маракучос", img: "img/smeshariki/marakuchos.jpg" },
      { name: "Таксист", img: "img/smeshariki/taxi.jpg" },
      { name: "Демон", img: "img/smeshariki/demon.jpg" },
      { name: "Зебра", img: "img/smeshariki/zebra.jpg" },
      { name: "Бегемот", img: "img/smeshariki/hippo.jpg" },
      { name: "Сибиряк", img: "img/smeshariki/siberian.jpg" },
      { name: "Вселенная", img: "img/smeshariki/universe.jpg" }
    ]
  };

  const STORAGE_KEY = "spy_game_players_v14";

  const els = {
    universe: document.getElementById("universe"),
    spyCount: document.getElementById("spyCount"),
    shuffleCards: document.getElementById("shuffleCards"),
    nameInput: document.getElementById("nameInput"),
    playerList: document.getElementById("playerList"),
    grid: document.getElementById("grid"),
    status: document.getElementById("status"),
    addBtn: document.getElementById("addBtn"),
    delLastBtn: document.getElementById("delLastBtn"),
    playBtn: document.getElementById("playBtn"),
    newRoundBtn: document.getElementById("newRoundBtn"),
    resetBtn: document.getElementById("resetBtn")
  };

  let players = [];
  let roundActive = false;

  const lastCharacterByUniverse = Object.create(null);

  function setStatus(text){
    els.status.textContent = text || "";
  }

  function setControlsLocked(locked){
    els.universe.disabled = locked;
    els.spyCount.disabled = locked ? true : (players.length < 3);
    els.shuffleCards.disabled = locked;
  }

  function randInt(max){
    return Math.floor(Math.random() * max);
  }

  function shuffleInPlace(arr){
    for(let i = arr.length - 1; i > 0; i--){
      const j = randInt(i + 1);
      const tmp = arr[i];
      arr[i] = arr[j];
      arr[j] = tmp;
    }
    return arr;
  }

  function normalizeName(s){
    return s.trim().replace(/\s+/g, " ");
  }

  function spyLabel(k){
    const mod10 = k % 10;
    const mod100 = k % 100;
    if(k === 0) return "0 шпионов";
    if(mod10 === 1 && mod100 !== 11) return k + " шпион";
    if(mod10 >= 2 && mod10 <= 4 && (mod100 < 12 || mod100 > 14)) return k + " шпиона";
    return k + " шпионов";
  }

  function savePlayers(){
    try{
      localStorage.setItem(STORAGE_KEY, JSON.stringify(players));
    } catch (e) {}
  }

  function loadPlayers(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return [];
      const parsed = JSON.parse(raw);
      if(!Array.isArray(parsed)) return [];
      return parsed
        .filter(x => typeof x === "string")
        .map(x => normalizeName(x))
        .filter(Boolean);
    } catch (e){
      return [];
    }
  }

  function cancelRoundIfActive(){
    if(!roundActive) return;
    els.grid.innerHTML = "";
    roundActive = false;
    setControlsLocked(false);
    setStatus("Партия сброшена из-за изменения списка игроков. Нажмите «Играть».");
  }

  function recomputeSpyOptions(){
    const n = players.length;

    if(n < 3){
      els.spyCount.innerHTML =
        '<option value="0">0 шпионов</option>' +
        '<option value="1">1 шпион</option>';
      els.spyCount.value = "1";
      els.spyCount.disabled = true;
      return;
    }

    els.spyCount.disabled = false;

    const maxSpies = Math.min(n - 1, Math.floor(n / 2));
    const prev = parseInt(els.spyCount.value || "1", 10);

    els.spyCount.innerHTML = "";

    const opt0 = document.createElement("option");
    opt0.value = "0";
    opt0.textContent = spyLabel(0);
    els.spyCount.appendChild(opt0);

    for(let k = 1; k <= maxSpies; k++){
      const opt = document.createElement("option");
      opt.value = String(k);
      opt.textContent = spyLabel(k);
      els.spyCount.appendChild(opt);
    }

    const capped = Math.min(Math.max(prev, 0), maxSpies);
    els.spyCount.value = String(capped);
  }

  function removePlayerAt(index){
    if(index < 0 || index >= players.length) return;
    cancelRoundIfActive();
    players.splice(index, 1);
    setStatus("");
    renderPlayers();
    savePlayers();
    els.nameInput.focus();
  }

  function renderPlayers(){
    els.playerList.innerHTML = "";

    for(let i = 0; i < players.length; i++){
      const pill = document.createElement("span");
      pill.className = "pill";

      const label = document.createElement("span");
      label.textContent = players[i];

      const x = document.createElement("button");
      x.className = "x";
      x.type = "button";
      x.title = "Удалить игрока";
      x.textContent = "×";
      x.onclick = () => removePlayerAt(i);

      pill.appendChild(label);
      pill.appendChild(x);
      els.playerList.appendChild(pill);
    }

    els.delLastBtn.disabled = players.length === 0;
    els.playBtn.disabled = players.length < 3;
    els.newRoundBtn.disabled = players.length < 3;

    recomputeSpyOptions();

    if(!roundActive) setControlsLocked(false);
  }

  function addPlayer(){
    const name = normalizeName(els.nameInput.value);
    if(!name) return;

    cancelRoundIfActive();

    const key = name.toLowerCase();
    if(players.some(p => p.toLowerCase() === key)){
      setStatus("Игрок с таким именем уже добавлен.");
      els.nameInput.select();
      return;
    }

    players.push(name);
    els.nameInput.value = "";
    setStatus("");
    renderPlayers();
    savePlayers();
    els.nameInput.focus();
  }

  function pickUniqueIndices(count, maxExclusive){
    const out = [];
    const used = new Set();
    const safeCount = Math.max(0, Math.min(count, maxExclusive));

    while(out.length < safeCount){
      const v = randInt(maxExclusive);
      if(!used.has(v)){
        used.add(v);
        out.push(v);
      }
    }
    return out;
  }

  function pickCharacterNoRepeat(universeKey, chars){
    if(!chars.length) return null;

    const lastName = lastCharacterByUniverse[universeKey];

    if(chars.length === 1){
      lastCharacterByUniverse[universeKey] = chars[0].name;
      return chars[0];
    }

    let chosen = chars[randInt(chars.length)];
    let guard = 0;
    while(chosen.name === lastName && guard < 20){
      chosen = chars[randInt(chars.length)];
      guard++;
    }

    lastCharacterByUniverse[universeKey] = chosen.name;
    return chosen;
  }

  function buildRoleNode(assignment){
    const role = document.createElement("div");
    role.className = "role" + (assignment.isSpy ? " spy" : "");

    if(assignment.isSpy){
      role.textContent = "ТЫ ШПИОН";
      return role;
    }

    const wrap = document.createElement("div");
    wrap.className = "char";

    const nm = document.createElement("div");
    nm.className = "charname";
    nm.textContent = assignment.role.name;

    const img = document.createElement("img");
    img.alt = assignment.role.name;

    img.onerror = () => {
      img.style.display = "none";
      const warn = document.createElement("div");
      warn.className = "smallnote";
      warn.textContent = "Картинка не найдена: " + assignment.role.img;
      wrap.insertBefore(warn, nm);
    };

    img.src = assignment.role.img;

    wrap.appendChild(img);
    wrap.appendChild(nm);
    role.appendChild(wrap);
    return role;
  }

  function startRound(){
    if(players.length < 3){
      setStatus("Минимум 3 игрока.");
      return;
    }

    const universeKey = els.universe.value;
    const chars = UNIVERSES[universeKey] || [];
    if(!chars.length){
      setStatus("Нет персонажей для выбранной вселенной.");
      return;
    }

    const spiesWanted = parseInt(els.spyCount.value || "1", 10);
    const spyIndices = new Set(pickUniqueIndices(spiesWanted, players.length));

    const common = pickCharacterNoRepeat(universeKey, chars);
    if(!common){
      setStatus("Нет персонажей для выбранной вселенной.");
      return;
    }

    let assignments = players.map((playerName, i) => ({
      name: playerName,
      isSpy: spyIndices.has(i),
      role: spyIndices.has(i)
        ? { type: "spy" }
        : { type: "char", name: common.name, img: common.img }
    }));

    if(els.shuffleCards.checked){
      assignments = shuffleInPlace(assignments);
    }

    els.grid.innerHTML = "";
    roundActive = true;
    setControlsLocked(true);
    setStatus("Роли распределены. Открывайте по очереди.");

    for(const a of assignments){
      const card = document.createElement("div");
      card.className = "card";

      const btn = document.createElement("button");
      btn.className = "namebtn";
      btn.type = "button";
      btn.textContent = a.name;

      let opened = false;

      btn.onclick = () => {
        if(!opened){
          opened = true;
          card.appendChild(buildRoleNode(a));
          return;
        }
        card.remove();
      };

      card.appendChild(btn);
      els.grid.appendChild(card);
    }
  }

  function newRound(){
    els.grid.innerHTML = "";
    roundActive = false;
    setControlsLocked(false);
    setStatus("Настройте параметры и нажмите «Играть».");
  }

  function resetAll(){
    players = [];
    els.grid.innerHTML = "";
    roundActive = false;
    setStatus("");
    setControlsLocked(false);
    renderPlayers();
    savePlayers();
    els.nameInput.focus();
  }

  function deleteLastPlayer(){
    if(players.length === 0) return;
    cancelRoundIfActive();
    players.pop();
    setStatus("");
    renderPlayers();
    savePlayers();
    els.nameInput.focus();
  }

  function wireEvents(){
    els.addBtn.onclick = addPlayer;

    els.nameInput.addEventListener("keydown", (e) => {
      if(e.key === "Enter") addPlayer();
    });

    els.delLastBtn.onclick = deleteLastPlayer;
    els.resetBtn.onclick = resetAll;

    els.playBtn.onclick = () => {
      if(roundActive){
        els.grid.innerHTML = "";
        roundActive = false;
      }
      startRound();
    };

    els.newRoundBtn.onclick = newRound;
  }

  (function init(){
    players = loadPlayers();
    wireEvents();
    renderPlayers();
    els.nameInput.focus();
  })();
</script>
</body>
</html>
